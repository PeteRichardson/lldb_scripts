#!/Library/Developer/CommandLineTools/usr/bin/python3
# NOTE:  must use the python3 in the CommandLineTools directory, not the Homebrew python3
#        because the Homebrew python3 does not have the lldb module

# make lldb module available
import sys
sys.path.append('/Library/Developer/CommandLineTools/Library/PrivateFrameworks/LLDB.framework/Versions/A/Resources/Python')
import lldb
import os

import argparse

def validate_binary(path):
    if os.path.exists(path) == False:
        raise argparse.ArgumentTypeError(f"'{path}' does not exist.")
    if not os.path.isfile(path):
        raise argparse.ArgumentTypeError(f"'{path}' is not a file.")
    return path

def get_parser():
    parser = argparse.ArgumentParser(description='List sections in a binary file (executable, shared library, object file, etc.) using lldb')
    parser.add_argument('binary', help='path to the binary to examine.',  type=validate_binary)
    #parser.add_argument('-c', '--csv', action='store_true', help='output in csv format')
    parser.add_argument('-d', '--dependencies', action='store_true', help='also examine dependent binaries')
    parser.add_argument('-k', '--skip-subsections', action='store_true', help='do not list subsections')
    return parser

if __name__ == '__main__':
    args = get_parser().parse_args()

    # Create a new debugger instance and a target
    debugger = lldb.SBDebugger.Create()
    target = debugger.CreateTarget (args.binary, None, None, args.dependencies, lldb.SBError())

    if target:
        for module in target.module_iter():
            for sec in module.section_iter():
                print(sec)
                if not args.skip_subsections:
                    for subsec in sec:
                        print(f"    {repr(subsec)}")
    else:
        print("# Failed to create target.  Check the filetype.", file=sys.stderr)       
